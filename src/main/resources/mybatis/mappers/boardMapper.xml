<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="board">
	<insert id="insert" parameterType="boardVo" useGeneratedKeys="true" keyProperty="no">
		insert	into board (
			title
		    , contents
		    , user_no
		    , group_no
		    <if test="parentNo neq 0">
		    	, order_no
			    , depth
			    , parent_no
		    </if>
		) values (
			#{title}
		    , #{contents}
		    , #{userNo}
		    <choose>
		    	<when test="parentNo eq 0">
		    		, (select ifnull(max(group_no) + 1, 1) from board as b)	
		    	</when>
		    	<otherwise>
		    		, #{groupNo}
				    , #{orderNo}
				    , #{depth}
				    , #{parentNo}	
		    	</otherwise>
		    </choose>
		);
	</insert>
	
	<update id="updateOrdering" parameterType="boardVo">
		<![CDATA[
		update	board 
		   set	order_no = order_no + 1 
		 where	group_no = #{groupNo} 
		   and	order_no >= #{orderNo}
		;
		]]>
	</update>
	
	<select id="getBoardCnt" parameterType="java.lang.String" resultType="int">
		select	count(*) as 'cnt' 
		  from	board 
		 where	title like concat('%', #{keyword}, '%')
		    or	contents like concat('%', #{keyword}, '%')
		;
	</select>
	
	<update id="increaseHitCnt" parameterType="boardVo">
		update	board 
		   set	hit = hit + 1 
		 where	no = #{no} 
		   and	use_yn = true
		;
	</update>
	
	<select id="getBoard" parameterType="boardVo" resultType="boardVo">
		select	no
				, title
		        , contents
		        , hit
		        , reg_date
		        , group_no
		        , order_no
		        , depth
		        , user_no
		        , parent_no
		  from	board
		 where	no = #{no}
		   and	use_yn = true
		;
	</select>
	
	<select id="getList" parameterType="searchForm" resultType="boardVo">
		select	b.no as 'no'
				, if(b.use_yn = true, b.title, '삭제된 게시글 입니다.') as 'title'
				, b.hit as 'hit'
		        , b.depth as 'depth'
		        , b.parent_no as 'parent_no'
		        , b.order_no as 'order_no'
		        , b.reg_date as 'reg_date'
		        , b.use_yn as 'use_yn'
		        , a.no as 'user_no'
		        , a.name as 'user_name'
		        , cc.cnt as 'comment_cnt'
		  from	board as b
		  join	user as a on b.user_no = a.no
		  left	join (
				select	board_no
						, count(*) as 'cnt' 
				  from	comment group by board_no
				) as cc on cc.board_no=b.no
		 where	(b.title like concat('%', #{keyword}, '%') or b.contents like concat('%', #{keyword}, '%'))
		 order	by group_no desc
				, order_no asc
		 limit	#{pagination.pageIndex}, #{pagination.listSize}
		;
	</select>
	
	<update id="update" parameterType="boardVo">
		update	board 
		   set	title=#{title}
				, contents=#{contents}
		 where	no=#{no}
		   and	user_no=#{userNo} 
		   and	use_yn=true
		;
	</update>
	
	<update id="delete" parameterType="boardVo">
		update	board
		   set	use_yn=false 
		 where	no=#{no}
		   and	user_no=#{userNo}
		;
	</update>
	
</mapper>